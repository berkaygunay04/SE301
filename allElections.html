<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
      <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/vote.png" />
    <title>I-Voted Admin</title>
	<!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
     <!-- FONTAWESOME STYLES-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
        <!-- CUSTOM STYLES-->
    <link href="assets/css/custom.css" rel="stylesheet" />
     <!-- GOOGLE FONTS-->
   <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

   <style>
   .btn {
     background-color: red;
     border: none;
     color: white;
     padding: 6px 12px;
     font-size: 20px;
     cursor: pointer;
     display: block;
     margin: auto;
     margin-top: 1px;
     margin-bottom: 1px;
     box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
   }

   /* Darker background on mouse-over */
   .btn:hover {
     background-color: green;
   }
   #loader {
  position: absolute;
  left: 50%;
  top: 50%;
  z-index: 1;
  width: 150px;
  height: 150px;
  margin: -75px 0 0 -75px;
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;
}

@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Add animation to "page content" */
.animate-bottom {
  position: relative;
  -webkit-animation-name: animatebottom;
  -webkit-animation-duration: 1s;
  animation-name: animatebottom;
  animation-duration: 1s
}

@-webkit-keyframes animatebottom {
  from { bottom:-100px; opacity:0 }
  to { bottom:0px; opacity:1 }
}

@keyframes animatebottom {
  from{ bottom:-100px; opacity:0 }
  to{ bottom:0; opacity:1 }
}

#myDiv {
  display: none;

}

.optionsMenu {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  border: 1px solid #e7e7e7;
  background-color: #f3f3f3;
}

.lili {
  float: left;
}

.lili a {
  display: block;
  color: black;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

.lili a:hover:not(.active) {
  background-color: #ddd;
}

.lili a.active {
  color: white;
  background-color: #15adcb;

}

table
 {
     word-break: break-all;
     border-collapse: collapse;
     width:100%;
 }
 td
 {
   width: 80px;
     border: 1px solid;
   }
   th
 {
   width: 80px;
     border: 1px solid;
 }
 .f{
   width: 320px;
   border: 1px solid;
 }

 .dsec{
   width: 120px;
   border: 1px solid;
 }

 .answers{
   width: 200px;
   border: 1px solid;
 }
   </style>
</head>
<body style="margin:0;">

  <div id="loader"></div>
<div style="display:none;" class="animate-bottom" id="myDiv">
<form id="formAdminMain" >
  <div id="wrapper">
       <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="adjust-nav">
              <div class="navbar-header">
                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </button>
                  <a class="navbar-brand" href="#">
                      <img src="assets/img/vote.png" />

                  </a>

              </div>
          </div>
      </div>
      <!-- /. NAV TOP  -->
      <nav class="navbar-default navbar-side" role="navigation">
          <div class="sidebar-collapse">
              <ul class="nav" id="main-menu">



                  <li>
                      <a href="mainElections.html" ><i class="fa fa-desktop "></i>Dashboard <span id="spanID2" class="badge" style="background-color:red"></span></a>
                  </li>
                  <li>
                     <a href="allUsers.html"><i class="fa fa-users "></i>Users <span id="spanID95"class="badge" style="background-color:red"></span></a>
                 </li>
                 <li class="active-link">
                    <a href="#"><i class="fa fa-edit "></i>User Elections</a>
                </li>
                <li>
                   <a href="myElections.html"><i class="fa fa-folder-open "></i>My Elections</a>
               </li>
                   <li>
                      <a href="changePassword.html"><i class="fa fa-lock "></i>Change Password</a>
                  </li>

                  <li>
                     <a onclick="logout1()" href="#"><i class="fa fa-power-off "></i>Logout</a>
                 </li>



              </ul>
            </div>

      </nav>
      <!-- /. NAV SIDE  -->
      <div id="page-wrapper" >
          <div id="page-inner">
              <div class="row">
                  <div class="col-lg-12">
                   <h2>ALL ELECTİONS</h2>
                  </div>
              </div>
               <!-- /. ROW  -->
                <hr />
              <div class="row">
                  <div class="col-lg-12 ">
                      <div>
                        <ul class="optionsMenu">
                          <li id="ongoingElections" class="lili"><a onclick="ongoingElections()" href="#">Ongoing Elections</a></li>
                          <li id="finishELections" class="lili"><a onclick="finishELections()" href="#">Finish Elections</a></li>
                          <li id="rejectElections" class="lili"><a onclick="rejectElections()" href="#">Rejected Elections</a></li>
                          <li id="deleteElections" class="lili"><a onclick="deleteElections()" href="#">Deleted Election</a></li>
                        </ul>
                      </div>

                  </div>
                  </div>
                <!-- /. ROW  -->
            <div>
              <div>

              </div>
              <h3 id="thereIsNo"></h3>
              <div class="main-list" id="list_div2">
                <div class="list-item">

                  <div class="butonClass">
                  </div>
                </div>
              </div>



            </div>
               <!-- /. ROW  -->

           <!-- /. PAGE INNER  -->
          </div>
       <!-- /. PAGE WRAPPER  -->
      </div>
  <div class="footer">


          <div class="row">
              <div class="col-lg-12" >
                  &copy;  2018 | Design by: <a style="color:#fff;" target="_blank">SE301-Voted Group</a>
              </div>
          </div>
      </div>

</from>
</div>


     <!-- /. WRAPPER  -->
    <!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
    <!-- JQUERY SCRIPTS -->
    <script src="assets/js/jquery-1.10.2.js"></script>
      <!-- BOOTSTRAP SCRIPTS -->
    <script src="assets/js/bootstrap.min.js"></script>
      <!-- CUSTOM SCRIPTS -->
    <script src="assets/js/custom.js"></script>


<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDpEfxHmFK0q0lpVFWK7DmpE7vgLLgPhr0",
    authDomain: "vote-a0e5a.firebaseapp.com",
    databaseURL: "https://vote-a0e5a.firebaseio.com",
    projectId: "vote-a0e5a",
    storageBucket: "vote-a0e5a.appspot.com",
    messagingSenderId: "384488603364"
  };
  firebase.initializeApp(config);
</script>

    <script>
    var currentUserID = "";
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        currentUserID = user.uid
        document.getElementById("formAdminLogin").action = "admin.html";
        document.getElementById("formAdminLogin").submit();
      } else {
        // No user is signed in.
        document.getElementById("formAdminMain").action = "login.html";
        document.getElementById("formAdminMain").submit();
      }
    });


    var countPending = 0;
    var badgePending = function(){
      firebase.database().ref("WaitingElections").on("child_added",function(elecSnap1){
        firebase.database().ref("WaitingElections").child(elecSnap1.key).on("child_added",function(elecSnap2){

            countPending += 1;
            document.getElementById("spanID2").innerHTML = countPending

        });
      });
    }
    badgePending();

    countBadgeUser = 0;
    var badgeUser = function(){
      firebase.database().ref("Kullanıcılar").on("child_added",function(snapshot){
        firebase.database().ref("Kullanıcılar").child(snapshot.key).on("value",function(snapshot2){
          var ozgur = snapshot2.val().Free
          if(ozgur == "Dondurmak istiyorum" || ozgur == "Açmak istiyorum"){
            countBadgeUser += 1;
            document.getElementById("spanID95").innerHTML = countBadgeUser
          }
        });
      });

    }
    badgeUser();

    function algoritma1(a,b,c){
      console.log(a,b,c);
      if(a == 0 && b == 0 && c == 0){
        return -1;
      }else{
        var sorting = [];
        sorting.push(a);
        sorting.push(b);
        sorting.push(c);

        sorting.sort(function(a, b){return a-b});

        if(sorting[2] == a){
          return a;
        }else if(sorting[2] == b){
          return b;
        }else if(sorting[2] == c){
          return c;
        }
      }

    }


    function yuzdeCalculater(gelen,toplam){
      var sonuc1 = (gelen * 100) / toplam;
      var sonuc2 = sonuc1.toString();
      var sonuc3 = sonuc2.substring(0,5);

      return sonuc3;
    }



    var count = 0;
    var OngoingElectionlariCek = function(){
      showLoading();
      const list_div = document.querySelector("#list_div2");
      var userRef = firebase.database().ref("Elections");
      userRef.on("value",function(snapshotValue){
        var exists = (snapshotValue.val() !== null);
        if(exists){
          userRef.on("child_added",function(snapshot){
              firebase.database().ref("Elections").child(snapshot.key).on("child_added",function(snapshot2){

                  firebase.database().ref("Kullanıcılar").on("child_added",function(userSnap1){
                    firebase.database().ref("Kullanıcılar").child(userSnap1.key).child("Elections").on("child_added",function(userSnap2){
                        if(snapshot2.key == userSnap2.key){
                          count += 1;
                          var sums = snapshot2.val().Option1C + snapshot2.val().Option2C + snapshot2.val().Option3C
                          var algoritmadanGelenSonuc = algoritma1(snapshot2.val().Option1C,snapshot2.val().Option2C,snapshot2.val().Option3C);
                          if(count % 2 == 0){
                            list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + count + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + userSnap1.val().name + " </td><td class='dsec'><b>" + snapshot.key + "</b></td><td class='dsec'>" + snapshot2.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td class='answers' id='option101' style='text-align:center'>" + snapshot2.val().Option1 + "<br>" + yuzdeCalculater(snapshot2.val().Option1C,sums) + "%</td><td class='answers' id='option102' style='text-align:center'>" + snapshot2.val().Option2 + "<br>" + yuzdeCalculater(snapshot2.val().Option2C,sums) + "%</td><td class='answers' id='option103' style='text-align:center'>" + snapshot2.val().Option3 + "<br>" + yuzdeCalculater(snapshot2.val().Option3C,sums) + "%</td><td class='dsec' style='text-color:green'>" + snapshot2.val().finishDate + "</td><td><button type='button' onclick='Delete(\"" +  snapshot2.key + "\",\"" +  userSnap1.val().email + "\",\"" +  snapshot2.val().ElectionName + "\")' class='btn'><i class='fa fa-trash'></i></button></td></tr></table></div>"

                          }else{
                            list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + count + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + userSnap1.val().name + " </td><td class='dsec'><b>" + snapshot.key + "</b></td><td class='dsec'>" + snapshot2.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td class='answers' id='option111' style='text-align:center'>" + snapshot2.val().Option1 + "<br>" + yuzdeCalculater(snapshot2.val().Option1C,sums) + "%</td><td class='answers' id='option112' style='text-align:center'>" + snapshot2.val().Option2 + "<br>" + yuzdeCalculater(snapshot2.val().Option2C,sums) + "%</td><td class='answers' id='option113' style='text-align:center'>" + snapshot2.val().Option3 + "<br>" + yuzdeCalculater(snapshot2.val().Option3C,sums) + "%</td><td class='dsec' style='text-color:green'>" + snapshot2.val().finishDate + "</td><td><button type='button' onclick='Delete(\"" +  snapshot2.key + "\",\"" +  userSnap1.val().email + "\",\"" +  snapshot2.val().ElectionName + "\")' class='btn'><i class='fa fa-trash'></i></button></td></tr></table></div>"

                          }
                        }
                        if(count == 0){
                          document.getElementById("thereIsNo").innerHTML = "There is no election."
                        }else{
                          document.getElementById("thereIsNo").innerHTML = "Elections"
                        }


                    });

                  });

              });
            //  thereIsNoElection2();
          });
        }else{
          document.getElementById("thereIsNo").innerHTML = "There is no election."
          //thereIsNoElection();
        }
        showPage();
      });

    }

    var countFinish = 0;
    var finishELectionsCek = function(){
      showLoading();
      const list_div = document.querySelector("#list_div2");

      var userRef = firebase.database().ref("Results");
      userRef.on("value",function(snapshotValue){
        var exists = (snapshotValue.val() !== null);
        if(exists){
          userRef.on("child_added",function(snapshot){
              firebase.database().ref("Results").child(snapshot.key).on("child_added",function(snapshot2){

                  firebase.database().ref("Kullanıcılar").on("child_added",function(userSnap1){
                    firebase.database().ref("Kullanıcılar").child(userSnap1.key).child("Elections").on("child_added",function(userSnap2){

                        // ve buraya tarih durumunu ekleyeceğiz. yani eğer bitme tarihi gelmemiş ve onaylanmış ise göster yapacağız.
                        if(snapshot2.key == userSnap2.key){
                          countFinish += 1;
                          var sums = snapshot2.val().Option1C + snapshot2.val().Option2C + snapshot2.val().Option3C
                          var algoritmadanGelenSonuc = algoritma1(snapshot2.val().Option1C,snapshot2.val().Option2C,snapshot2.val().Option3C);
                          if(countFinish % 2 == 0){
                            list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + countFinish + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + userSnap1.val().name + " </td><td class='dsec'><b>" + snapshot.key + "</b></td><td>" + snapshot2.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td class='answers' id='option1' style='text-align:center'>" + snapshot2.val().Option1 + "<br>" + yuzdeCalculater(snapshot2.val().Option1C,sums) + "%</td><td class='answers' id='option2' style='text-align:center'>" + snapshot2.val().Option2 + "<br>" + yuzdeCalculater(snapshot2.val().Option2C,sums) + "%</td><td class='answers' id='option3' style='text-align:center'>" + snapshot2.val().Option3 + "<br>" + yuzdeCalculater(snapshot2.val().Option3C,sums) + "%</td><td class='dsec' style='text-color:red'>" + snapshot2.val().finishDate + "</td></tr></table></div>"
                            if(algoritmadanGelenSonuc == snapshot2.val().Option1C){
                              document.getElementById("option1").style.backgroundColor = "#66cb39";
                              document.getElementById("option1").style.color = "white";

                              console.log(algoritmadanGelenSonuc);
                            }else if(algoritmadanGelenSonuc == snapshot2.val().Option2C){
                              document.getElementById("option2").style.backgroundColor = "#66cb39";
                              document.getElementById("option2").style.color = "white";
                            }else{
                              document.getElementById("option3").style.backgroundColor = "#66cb39";
                              document.getElementById("option3").style.color = "white";
                            }
                          }else{
                            list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + countFinish + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + userSnap1.val().name + " </td><td class='dsec'><b>" + snapshot.key + "</b></td><td>" + snapshot2.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td class='answers' id='option11' style='text-align:center'>" + snapshot2.val().Option1 + "<br>" + yuzdeCalculater(snapshot2.val().Option1C,sums) + "%</td><td class='answers' id='option21' style='text-align:center'>" + snapshot2.val().Option2 + "<br>" + yuzdeCalculater(snapshot2.val().Option2C,sums) + "%</td><td class='answers'id='option31' style='text-align:center'>" + snapshot2.val().Option3 + "<br>" + yuzdeCalculater(snapshot2.val().Option3C,sums) + "%</td><td class='dsec' style='text-color:red'>" + snapshot2.val().finishDate + "</td></tr></table></div>"
                            if(algoritmadanGelenSonuc == snapshot2.val().Option1C){
                              document.getElementById("option11").style.backgroundColor = "#66cb39";
                              document.getElementById("option11").style.color = "white";

                              console.log(algoritmadanGelenSonuc);
                            }else if(algoritmadanGelenSonuc == snapshot2.val().Option2C){
                              document.getElementById("option21").style.backgroundColor = "#66cb39";
                              document.getElementById("option21").style.color = "white";
                            }else{
                              document.getElementById("option31").style.backgroundColor = "#66cb39";
                              document.getElementById("option31").style.color = "white";
                            }
                          }
                        }
                        if(countFinish == 0){
                          document.getElementById("thereIsNo").innerHTML = "There is no election."
                          console.log("fkdsjgkfj");

                        }else{
                          document.getElementById("thereIsNo").innerHTML = "Elections"
                        }
                        console.log(countFinish);

                    });

                  });

              });
              //thereIsNoElection2();
          });
        }else{
          document.getElementById("thereIsNo").innerHTML = "There is no election."
          //thereIsNoElection();
        }
        showPage();
      });

    }



    function logout1(){
      firebase.auth().signOut().then(function() {
        console.log('Signed Out');
      }, function(error) {
        console.error('Sign Out Error', error);
      });
    }

    function Finish(){
      alert("Bitirme işlemi eklenecek");
    }

    function Delete(electionKey,email,electionName){
      var reason = prompt("Please enter reason for deleting:");
        if(reason == null || reason == ""){
          alert("Reason cannot be empty!");
        }else{
          var electionRef = firebase.database().ref("Elections");
          electionRef.on("child_added",function(snapshot){
            var electionRef2 = firebase.database().ref("Elections").child(snapshot.key);
            electionRef2.on("child_added",function(snapshot2){
              if(snapshot2.key == electionKey){ // burda tarihe göre sıralandığı için db de gelen key de tarih key olduğundan karşılaştırma yapıp hangisi geldiyse onu siliyorum.
                var r=confirm("Do you want to delete election ?");
                if(r){

                  firebase.database().ref("DeleteElections").child(snapshot.key).child(snapshot2.key).set({
                    ElectionName: snapshot2.val().ElectionName,
                    Option1: snapshot2.val().Option1,
                    Option2: snapshot2.val().Option2,
                    Option3: snapshot2.val().Option3,
                    Option1C: snapshot2.val().Option1C,
                    Option2C: snapshot2.val().Option2C,
                    Option3C: snapshot2.val().Option3C,
                    AdminOnay: false,
                    Question: snapshot2.val().Question,
                    VoteCount: snapshot2.val().VoteCount,
                    finishDate: snapshot2.val().finishDate,
                    Reason: reason
                  });

                  snapshot2.ref.remove(function(error){
                    alert("Deleting is success!");
                      timedRefresh(1);
                  });
                  var from,to,subject,text;
                    to= email
                    subject= electionName
                    text="Your election is deleted by admin. If you see delete reason, please enter 'my delete elections' in app.\n\n\nHave a good day :) \n\nContact us : info@ivoted.com"
                    $.get("http://localhost:3000/send",{to:to,subject:subject,text:text},function(data){
                    if(data=="sent")
                    {
                      console.log("success");
                    }
                  });
                }else {
                  //return false;
                }

              }
            });
          });
        }
    }

    console.log("Kontrol : ",localStorage.getItem("deleteDurumu"));
    var text = localStorage.getItem("deleteDurumu");
    console.log("text : ",text);

    if(text == "true"){
      document.getElementById("deleteElections").style.backgroundColor = "#15adcb";
      dbDekiDeleteElectionlar();
      localStorage.setItem("deleteDurumu", "false");
      console.log("Kontrol : ",localStorage.getItem("deleteDurumu"));
    }else{
      console.log("Kontrol : ",text);
      document.getElementById("ongoingElections").style.backgroundColor = "#15adcb";
      OngoingElectionlariCek();
    }

    var count2 = 0;
    var names = "";
    function dbDekiDeleteElectionlar(){
      showLoading();
      const list_div = document.querySelector("#list_div2");
      firebase.database().ref("DeleteElections").on("value",function(snapshotValue){
        var exists = (snapshotValue.val() !== null);
        if(exists){
          var dbRef = firebase.database().ref("DeleteElections");
          dbRef.on("child_added",function(snapshot2){
            var dbRef2 = firebase.database().ref("DeleteElections").child(snapshot2.key);
            dbRef2.on("child_added",function(snapshot){
              firebase.database().ref("Kullanıcılar").on("child_added",function(snapshot6){
                firebase.database().ref("Kullanıcılar").child(snapshot6.key).child("Elections").on("child_added",function(snapshot7){
                  if(snapshot7.key == snapshot.key){
                    names = snapshot6.val().name
                    count2 += 1;
                    if(count2 % 2 == 0){
                      list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + count2 + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + names + " </td><td class='dsec'><b>" + snapshot2.key + "</b></td><td class='dsec'>" + snapshot.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot.val().Question + "</b></td><td class='answers' style='text-decoration:underline'>" + snapshot.val().Option1 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot.val().Option2 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot.val().Option3 + "</td><td class='dsec' style='text-color:red'>" + snapshot.val().finishDate + "</td></tr></table></div>"
                    }else{
                      list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + count2 + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + names+ " </td><td class='dsec'><b>" + snapshot2.key + "</b></td><td class='dsec'>" + snapshot.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot.val().Question + "</b></td><td class='answers' style='text-decoration:underline'>" + snapshot.val().Option1 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot.val().Option2 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot.val().Option3 + "</td><td class='dsec' style='text-color:red'>" + snapshot.val().finishDate + "</td></tr></table></div>"
                    }
                  }
                  console.log(count2);
                  if(count2 == 0){
                    document.getElementById("thereIsNo").innerHTML = "There is no election."
                    //thereIsNoElection();
                  }else{
                    document.getElementById("thereIsNo").innerHTML = "Elections"
                    //thereIsNoElection2();
                  }

                });

              });

            });
            //thereIsNoElection2();
          });
        }else{
          document.getElementById("thereIsNo").innerHTML = "There is no election."
          //thereIsNoElection();
        }
        showPage();
      });


    }

    var countReject = 0;
    var rejectElectionslariCek = function(){
      showLoading();
      const list_div = document.querySelector("#list_div2");
      firebase.database().ref("RejectedElections").on("value",function(snapshotValue){

        var exists = (snapshotValue.val() !== null);
        if(exists){
          console.log("fkdsjgkjkajkdjka");
          firebase.database().ref("RejectedElections").on("child_added",function(rejectSnap){
            firebase.database().ref("RejectedElections").child(rejectSnap.key).on("child_added",function(rejectSnap2){
              firebase.database().ref("Kullanıcılar").on("child_added",function(userSnap1){
                firebase.database().ref("Kullanıcılar").child(userSnap1.key).child("Elections").on("child_added",function(userSnap2){
                  if(userSnap2.key == rejectSnap2.key){
                    countReject += 1;
                    if(countReject % 2 == 0){
                      list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + countReject + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + userSnap1.val().name + " </td><td class='dsec'><b>" + rejectSnap.key + "</b></td><td class='f'><b style='color:blue'>" + rejectSnap2.val().Question + "</b></td><td class='answers' style='text-decoration:underline'>" + rejectSnap2.val().Option1 + "</td><td class='answers' style='text-decoration:underline'>" + rejectSnap2.val().Option2 + "</td><td class='answers' style='text-decoration:underline'>" + rejectSnap2.val().Option3 + "</td><td class='dsec' style='text-color:orange'>" + rejectSnap2.val().finishDate + "</td></tr></table></div>"
                    }else{
                      list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + countReject + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + userSnap1.val().name + " </td><td class='dsec'><b>" + rejectSnap.key + "</b></td><td class='f'><b style='color:blue'>" + rejectSnap2.val().Question + "</b></td><td class='answers' style='text-decoration:underline'>" + rejectSnap2.val().Option1 + "</td><td class='answers' style='text-decoration:underline'>" + rejectSnap2.val().Option2 + "</td><td class='answers' style='text-decoration:underline'>" + rejectSnap2.val().Option3 + "</td><td class='dsec' style='text-color:orange'>" + rejectSnap2.val().finishDate + "</td></tr></table></div>"

                    }
                  }
                  if(countReject == 0){
                    document.getElementById("thereIsNo").innerHTML = "There is no election."
                    //thereIsNoElection();
                  }else{
                    document.getElementById("thereIsNo").innerHTML = "Elections"
                    //thereIsNoElection2();
                  }
                });
              });
            });


          });
        }else{
          document.getElementById("thereIsNo").innerHTML = "There is no election."
        }
        showPage();
      });

    }

    function deleteElections(){
      count2 = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      dbDekiDeleteElectionlar();
      document.getElementById("finishELections").style.backgroundColor = "#f3f3f3";
      document.getElementById("ongoingElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("deleteElections").style.backgroundColor = "#15adcb";
      document.getElementById("rejectElections").style.backgroundColor = "#f3f3f3";
    }

    function ongoingElections(){
      count = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      OngoingElectionlariCek();
      document.getElementById("finishELections").style.backgroundColor = "#f3f3f3";
      document.getElementById("ongoingElections").style.backgroundColor = "#15adcb";
      document.getElementById("deleteElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("rejectElections").style.backgroundColor = "#f3f3f3";

    }

    function rejectElections(){
      countReject = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      rejectElectionslariCek();
      document.getElementById("finishELections").style.backgroundColor = "#f3f3f3";
      document.getElementById("ongoingElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("deleteElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("rejectElections").style.backgroundColor = "#15adcb";
    }

    function finishELections(){
      countFinish = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      finishELectionsCek();
      document.getElementById("finishELections").style.backgroundColor = "#15adcb";
      document.getElementById("ongoingElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("deleteElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("rejectElections").style.backgroundColor = "#f3f3f3";
    }

    function timedRefresh(timeoutPeriod) {
    setTimeout("location.reload(true);",timeoutPeriod); // otomatik refresh.
    }

    function showPage() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("myDiv").style.display = "block";
    }

    function showLoading() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("myDiv").style.display = "none";
    }


    /*var getData = function(){
         firebase.database().ref("Elections").on("child_added",function(electionSnap1){
           firebase.database().ref("Elections").child(electionSnap1.key).on("child_added",function(elecSnap2){
            var finishDate = elecSnap2.val().finishDate
             finising(elecSnap2.key,finishDate);
           });
         });
       }
       getData();

       function finising(electionKey,finishDate){
         var kalanGun = diffDate(finishDate);
         if(kalanGun == 0){
           changeStatus(electionKey);
         }
       }

       function changeStatus(electionKey){
         firebase.database().ref("Elections").on("child_added",function(snapshot){
           firebase.database().ref("Elections").child(snapshot.key).child(electionKey).update({
             Durum: false
           });
         });
       }*/

       function currentDay(){
       var dateObj = new Date();
       var month = ("0" + (dateObj.getMonth() + 1)).slice(-2); //months from 1-12
       var day = ("0" + dateObj.getDate()).slice(-2)
       var year = dateObj.getFullYear();
       return newdate = year + "-" + month + "-" + day;
       }

   function diffDate(finishDate){
     var date1 = new Date(finishDate);
     var datesC = currentDay();
     var date2 = new Date(datesC);
     var timeDiff = Math.abs(date2.getTime() - date1.getTime());
     var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
     return diffDays;
   }

    </script>

</body>
</html>
