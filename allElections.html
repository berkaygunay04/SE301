<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
      <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>I-Voted Admin</title>
	<!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
     <!-- FONTAWESOME STYLES-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
        <!-- CUSTOM STYLES-->
    <link href="assets/css/custom.css" rel="stylesheet" />
     <!-- GOOGLE FONTS-->
   <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />

   <style>
   #loader {
  position: absolute;
  left: 50%;
  top: 50%;
  z-index: 1;
  width: 150px;
  height: 150px;
  margin: -75px 0 0 -75px;
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;
}

@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Add animation to "page content" */
.animate-bottom {
  position: relative;
  -webkit-animation-name: animatebottom;
  -webkit-animation-duration: 1s;
  animation-name: animatebottom;
  animation-duration: 1s
}

@-webkit-keyframes animatebottom {
  from { bottom:-100px; opacity:0 }
  to { bottom:0px; opacity:1 }
}

@keyframes animatebottom {
  from{ bottom:-100px; opacity:0 }
  to{ bottom:0; opacity:1 }
}

#myDiv {
  display: none;

}

.optionsMenu {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  border: 1px solid #e7e7e7;
  background-color: #f3f3f3;
}

.lili {
  float: left;
}

.lili a {
  display: block;
  color: black;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

.lili a:hover:not(.active) {
  background-color: #ddd;
}

.lili a.active {
  color: white;
  background-color: #15adcb;

}
   </style>
</head>
<body style="margin:0;">

  <div id="loader"></div>
<div style="display:none;" class="animate-bottom" id="myDiv">
<form id="formAdminMain" >
  <div id="wrapper">
       <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="adjust-nav">
              <div class="navbar-header">
                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </button>
                  <a class="navbar-brand" href="#">
                      <img src="assets/img/vote.png" />

                  </a>

              </div>
          </div>
      </div>
      <!-- /. NAV TOP  -->
      <nav class="navbar-default navbar-side" role="navigation">
          <div class="sidebar-collapse">
              <ul class="nav" id="main-menu">



                  <li>
                      <a href="index.html" ><i class="fa fa-desktop "></i>Dashboard <span id="spanID2" class="badge" style="background-color:red"></span></a>
                  </li>
                  <li>
                     <a href="allUsers.html"><i class="fa fa-users "></i>Users</a>
                 </li>
                 <li class="active-link">
                    <a href="#"><i class="fa fa-edit "></i>User Elections</a>
                </li>
                <li>
                   <a href="myElections.html"><i class="fa fa-folder-open "></i>My Elections</a>
               </li>
                   <li>
                      <a href="changePassword.html"><i class="fa fa-lock "></i>Change Password</a>
                  </li>

                  <li>
                     <a onclick="logout1()" href="#"><i class="fa fa-power-off "></i>Logout</a>
                 </li>



              </ul>
            </div>

      </nav>
      <!-- /. NAV SIDE  -->
      <div id="page-wrapper" >
          <div id="page-inner">
              <div class="row">
                  <div class="col-lg-12">
                   <h2>ALL ELECTİONS</h2>
                  </div>
              </div>
               <!-- /. ROW  -->
                <hr />
              <div class="row">
                  <div class="col-lg-12 ">
                      <div>
                        <ul class="optionsMenu">
                          <li id="ongoingElections" class="lili"><a onclick="ongoingElections()" href="#">Ongoing Elections</a></li>
                          <li id="finishELections" class="lili"><a onclick="finishELections()" href="#">Finish Elections</a></li>
                          <li id="rejectElections" class="lili"><a onclick="rejectElections()" href="#">Rejected Elections</a></li>
                          <li id="deleteElections" class="lili"><a onclick="deleteElections()" href="#">Delete Election</a></li>
                        </ul>
                      </div>

                  </div>
                  </div>
                <!-- /. ROW  -->
            <div>
              <div>

              </div>

              <div class="main-list" id="list_div2">
                <div class="list-item">
                  <h3>Elections</h3>

                  <div class="butonClass">
                  </div>
                </div>
              </div>



            </div>
               <!-- /. ROW  -->

           <!-- /. PAGE INNER  -->
          </div>
       <!-- /. PAGE WRAPPER  -->
      </div>
  <div class="footer">


          <div class="row">
              <div class="col-lg-12" >
                  &copy;  2018 | Design by: <a style="color:#fff;" target="_blank">SE301-Voted Group</a>
              </div>
          </div>
      </div>

</from>
</div>


     <!-- /. WRAPPER  -->
    <!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
    <!-- JQUERY SCRIPTS -->
    <script src="assets/js/jquery-1.10.2.js"></script>
      <!-- BOOTSTRAP SCRIPTS -->
    <script src="assets/js/bootstrap.min.js"></script>
      <!-- CUSTOM SCRIPTS -->
    <script src="assets/js/custom.js"></script>


<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDpEfxHmFK0q0lpVFWK7DmpE7vgLLgPhr0",
    authDomain: "vote-a0e5a.firebaseapp.com",
    databaseURL: "https://vote-a0e5a.firebaseio.com",
    projectId: "vote-a0e5a",
    storageBucket: "vote-a0e5a.appspot.com",
    messagingSenderId: "384488603364"
  };
  firebase.initializeApp(config);
</script>

    <script>
    var currentUserID = "";
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        currentUserID = user.uid
        document.getElementById("formAdminLogin").action = "admin.html";
        document.getElementById("formAdminLogin").submit();
      } else {
        // No user is signed in.
        document.getElementById("formAdminMain").action = "login.html";
        document.getElementById("formAdminMain").submit();
      }
    });


    var countPending = 0;
    var badgePending = function(){
      firebase.database().ref("Elections").on("child_added",function(elecSnap1){
        firebase.database().ref("Elections").child(elecSnap1.key).on("child_added",function(elecSnap2){
          if(elecSnap2.val().AdminOnay == false){
            countPending += 1;
            document.getElementById("spanID2").innerHTML = countPending
          }
        });
      });
    }
    badgePending();



    var count = 0;
    var OngoingElectionlariCek = function(){
      showLoading();
      const list_div = document.querySelector("#list_div2");
      var userRef = firebase.database().ref("Elections");
      userRef.on("child_added",function(snapshot){
        firebase.database().ref("Elections").child(snapshot.key).on("child_added",function(snapshot2){
          firebase.database().ref("Kullanıcılar").on("child_added",function(userSnap1){
            firebase.database().ref("Kullanıcılar").child(userSnap1.key).child("Elections").on("child_added",function(userSnap2){
              if(snapshot2.val().AdminOnay == true){

                // ve buraya tarih durumunu ekleyeceğiz. yani eğer bitme tarihi gelmemiş ve onaylanmış ise göster yapacağız.

                if(snapshot2.key == userSnap2.key){
                  count += 1;
                  if(count % 2 == 0){
                    list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + count + "</tr><tr><th>Sender</th><th>Category</th><th>Election Name</th><th>Ouestion</th><th>Option1</th><th>Option2</th><th>Option3</th></tr><tr><td> " + userSnap1.val().name + " </td><td><b>" + snapshot.key + "</b></td><td>" + snapshot2.val().ElectionName + "</td><td><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td style='text-decoration:underline'>" + snapshot2.val().Option1 + "</td><td style='text-decoration:underline'>" + snapshot2.val().Option2 + "</td><td style='text-decoration:underline'>" + snapshot2.val().Option3 + "</td><td><th><button onclick='stop()' style='background-color:red;color:white' class='buttons'>Stop</button></th><th><button onclick='Delete(\"" +  snapshot2.key + "\")' style='background-color:red;color:white' class='buttons'>Delete</button></th></td></tr></table></div>"
                  }else{
                    list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + count + "</tr><tr><th>Sender</th><th>Category</th><th>Election Name</th><th>Ouestion</th><th>Option1</th><th>Option2</th><th>Option3</th></tr><tr><td> " + userSnap1.val().name + " </td><td><b>" + snapshot.key + "</b></td><td>" + snapshot2.val().ElectionName + "</td><td><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td style='text-decoration:underline'>" + snapshot2.val().Option1 + "</td><td style='text-decoration:underline'>" + snapshot2.val().Option2 + "</td><td style='text-decoration:underline'>" + snapshot2.val().Option3 + "</td><td><th><button onclick='stop()' style='background-color:red;color:white' class='buttons'>Stop</button></th><th><button onclick='Delete(\"" +  snapshot2.key + "\")' style='background-color:red;color:white' class='buttons'>Delete</button></th></td></tr></table></div>"
                  }
                }

              }

            });
          });

        });
        showPage();
      });
    }

    function stop(){
      alert("Anket devam ederken durduralabilecek mi ? (Hocaya soracağız)")
    }


    function logout1(){
      firebase.auth().signOut().then(function() {
        console.log('Signed Out');
      }, function(error) {
        console.error('Sign Out Error', error);
      });
    }

    function Finish(){
      alert("Bitirme işlemi eklenecek");
    }

    function Delete(electionKey){
      var electionRef = firebase.database().ref("Elections");
      electionRef.on("child_added",function(snapshot){
        var electionRef2 = firebase.database().ref("Elections").child(snapshot.key);
        electionRef2.on("child_added",function(snapshot2){
          if(snapshot2.key == electionKey){ // burda tarihe göre sıralandığı için db de gelen key de tarih key olduğundan karşılaştırma yapıp hangisi geldiyse onu siliyorum.
            if(confirm("Silmek istediğinize eminmisiniz ?")){

              firebase.database().ref("DeleteElections").child(snapshot.key).child(snapshot2.key).set({
                ElectionName: snapshot2.val().ElectionName,
                Option1: snapshot2.val().Option1,
                Option2: snapshot2.val().Option2,
                Option3: snapshot2.val().Option3,
                Option1C: snapshot2.val().Option1C,
                Option2C: snapshot2.val().Option2C,
                Option3C: snapshot2.val().Option3C,
                AdminOnay: false,
                Question: snapshot2.val().Question,
                VoteCount: snapshot2.val().VoteCount,
              });

              snapshot2.ref.remove(function(error){
                  window.onload = timedRefresh(1);
              });
            }

          }
        });
      });

    }
    console.log("Kontrol : ",localStorage.getItem("deleteDurumu"));
    var text = localStorage.getItem("deleteDurumu");
    console.log("text : ",text);

    if(text == "true"){
      document.getElementById("deleteElections").style.backgroundColor = "#15adcb";
      dbDekiDeleteElectionlar();
      localStorage.setItem("deleteDurumu", "false");
      console.log("Kontrol : ",localStorage.getItem("deleteDurumu"));
    }else{
      console.log("Kontrol : ",text);
      document.getElementById("ongoingElections").style.backgroundColor = "#15adcb";
      OngoingElectionlariCek();
    }

    var count2 = 0;
    var names = "";
    function dbDekiDeleteElectionlar(){
      showLoading();
      const list_div = document.querySelector("#list_div2");
      var dbRef = firebase.database().ref("DeleteElections");
      dbRef.on("child_added",function(snapshot2){
        var dbRef2 = firebase.database().ref("DeleteElections").child(snapshot2.key);
        dbRef2.on("child_added",function(snapshot){
          firebase.database().ref("Kullanıcılar").on("child_added",function(snapshot6){
            firebase.database().ref("Kullanıcılar").child(snapshot6.key).child("Elections").on("child_added",function(snapshot7){
              if(snapshot7.key == snapshot.key){
                names = snapshot6.val().name
                count2 += 1;
                if(count2 % 2 == 0){
                  list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + count2 + "</tr><tr><th>Sender</th><th>Category</th><th>Election Name</th><th>Ouestion</th><th>Option1</th><th>Option2</th><th>Option3</th></tr><tr><td> " + names + " </td><td><b>" + snapshot2.key + "</b></td><td>" + snapshot.val().ElectionName + "</td><td><b style='color:blue'>" + snapshot.val().Question + "</b></td><td style='text-decoration:underline'>" + snapshot.val().Option1 + "</td><td style='text-decoration:underline'>" + snapshot.val().Option2 + "</td><td style='text-decoration:underline'>" + snapshot.val().Option3 + "</td></tr></table></div>"
                }else{
                  list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + count2 + "</tr><tr><th>Sender</th><th>Category</th><th>Election Name</th><th>Ouestion</th><th>Option1</th><th>Option2</th><th>Option3</th></tr><tr><td> " + names+ " </td><td><b>" + snapshot2.key + "</b></td><td>" + snapshot.val().ElectionName + "</td><td><b style='color:blue'>" + snapshot.val().Question + "</b></td><td style='text-decoration:underline'>" + snapshot.val().Option1 + "</td><td style='text-decoration:underline'>" + snapshot.val().Option2 + "</td><td style='text-decoration:underline'>" + snapshot.val().Option3 + "</td></tr></table></div>"
                }
              }

            });
          });

        });
        showPage();
      });

    }

    var countReject = 0;
    var rejectElectionslariCek = function(){
      showLoading();
      const list_div = document.querySelector("#list_div2");
      firebase.database().ref("RejectedElections").on("child_added",function(rejectSnap){
        firebase.database().ref("RejectedElections").child(rejectSnap.key).on("child_added",function(rejectSnap2){
          firebase.database().ref("Kullanıcılar").on("child_added",function(userSnap1){
            firebase.database().ref("Kullanıcılar").child(userSnap1.key).child("Elections").on("child_added",function(userSnap2){
              if(userSnap2.key == rejectSnap2.key){
                countReject += 1;
                if(countReject % 2 == 0){
                  list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + countReject + "</tr><tr><th>Sender</th><th>Category</th><th>Ouestion</th><th>Option1</th><th>Option2</th><th>Option3</th></tr><tr><td> " + userSnap1.val().name + " </td><td><b>" + rejectSnap.key + "</b></td><td><b style='color:blue'>" + rejectSnap2.val().Question + "</b></td><td style='text-decoration:underline'>" + rejectSnap2.val().Option1 + "</td><td style='text-decoration:underline'>" + rejectSnap2.val().Option2 + "</td><td style='text-decoration:underline'>" + rejectSnap2.val().Option3 + "</td></tr></table></div>"
                }else{
                  list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + countReject + "</tr><tr><th>Sender</th><th>Category</th><th>Ouestion</th><th>Option1</th><th>Option2</th><th>Option3</th></tr><tr><td> " + userSnap1.val().name + " </td><td><b>" + rejectSnap.key + "</b></td><td><b style='color:blue'>" + rejectSnap2.val().Question + "</b></td><td style='text-decoration:underline'>" + rejectSnap2.val().Option1 + "</td><td style='text-decoration:underline'>" + rejectSnap2.val().Option2 + "</td><td style='text-decoration:underline'>" + rejectSnap2.val().Option3 + "</td></tr></table></div>"

                }
              }
            });
          });
        });
        showPage();
      });
    }

    function deleteElections(){
      count2 = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      dbDekiDeleteElectionlar();
      document.getElementById("finishELections").style.backgroundColor = "#f3f3f3";
      document.getElementById("ongoingElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("deleteElections").style.backgroundColor = "#15adcb";
      document.getElementById("rejectElections").style.backgroundColor = "#f3f3f3";
    }

    function ongoingElections(){
      count = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      OngoingElectionlariCek();
      document.getElementById("finishELections").style.backgroundColor = "#f3f3f3";
      document.getElementById("ongoingElections").style.backgroundColor = "#15adcb";
      document.getElementById("deleteElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("rejectElections").style.backgroundColor = "#f3f3f3";

    }

    function rejectElections(){

      countReject = 0;
      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      rejectElectionslariCek();
      document.getElementById("finishELections").style.backgroundColor = "#f3f3f3";
      document.getElementById("ongoingElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("deleteElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("rejectElections").style.backgroundColor = "#15adcb";
    }

    function finishELections(){

      const list_div = document.querySelector("#list_div2");
      list_div.innerHTML = ""
      document.getElementById("finishELections").style.backgroundColor = "#15adcb";
      document.getElementById("ongoingElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("deleteElections").style.backgroundColor = "#f3f3f3";
      document.getElementById("rejectElections").style.backgroundColor = "#f3f3f3";
      alert("Eklenecek");
    }

    function timedRefresh(timeoutPeriod) {
    setTimeout("location.reload(true);",timeoutPeriod); // otomatik refresh.
    }

    function showPage() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("myDiv").style.display = "block";
    }

    function showLoading() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("myDiv").style.display = "none";
    }

    </script>

</body>
</html>
