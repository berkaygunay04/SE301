<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
      <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/vote.png" />
    <title>I-Voted Admin</title>
	<!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
     <!-- FONTAWESOME STYLES-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
        <!-- CUSTOM STYLES-->
    <link href="assets/css/custom.css" rel="stylesheet" />
     <!-- GOOGLE FONTS-->
   <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>
<style>
.btn {
  background-color: #5ba631;
  border: none;
  border-radius: 5px;
  color: white;
  padding: 8px 14px;
  font-size: 20px;
  cursor: pointer;
  display: block;
  margin: auto;
  margin-top: 1px;
  box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
}

/* Darker background on mouse-over */
.btn:hover {
  background-color: blue;
}
.btn2 {
  background-color: red;
  border: none;
  border-radius: 5px;
  color: white;
  padding: 8px 16px;
  font-size: 20px;
  cursor: pointer;
  display: block;
  margin: auto;
  margin-top: 2px;
  margin-bottom: 1px;
  box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
}

/* Darker background on mouse-over */
.btn2:hover {
  background-color: blue;
}
table
 {
     word-break: break-all;
     border-collapse: collapse;
     width:100%;
 }
 td
 {
   width: 80px;
     border: 1px solid;
   }
   th
 {
   width: 80px;
     border: 1px solid;
 }
 .f{
   width: 320px;
   border: 1px solid;
 }

 .dsec{
   width: 120px;
   border: 1px solid;
 }

 .answers{
   width: 200px;
   border: 1px solid;
 }
#loader {
position: absolute;
left: 50%;
top: 50%;
z-index: 1;
width: 150px;
height: 150px;
margin: -75px 0 0 -75px;
border: 16px solid #f3f3f3;
border-radius: 50%;
border-top: 16px solid #3498db;
width: 120px;
height: 120px;
-webkit-animation: spin 2s linear infinite;
animation: spin 2s linear infinite;
}

@-webkit-keyframes spin {
0% { -webkit-transform: rotate(0deg); }
100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Add animation to "page content" */
.animate-bottom {
position: relative;
-webkit-animation-name: animatebottom;
-webkit-animation-duration: 1s;
animation-name: animatebottom;
animation-duration: 1s
}

@-webkit-keyframes animatebottom {
from { bottom:-100px; opacity:0 }
to { bottom:0px; opacity:1 }
}

@keyframes animatebottom {
from{ bottom:-100px; opacity:0 }
to{ bottom:0; opacity:1 }
}

#myDiv {
display: none;

}

.textareaStyle{
  width: 50%;
  height: 80px;
  margin-top: 5px;
}

</style>
<body style="margin:0;">

<div id="loader"></div>
<div style="display:none;" class="animate-bottom" id="myDiv">
<form id="formAdminMain">
  <div id="wrapper">
       <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="adjust-nav">
              <div class="navbar-header">
                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </button>
                  <a class="navbar-brand" href="#">
                      <img src="assets/img/vote.png" />

                  </a>

              </div>
          </div>
      </div>
      <!-- /. NAV TOP  -->
      <nav class="navbar-default navbar-side" role="navigation">
          <div class="sidebar-collapse">
              <ul class="nav" id="main-menu">



                  <li>
                      <a href="mainElections.html" ><i class="fa fa-desktop "></i>Dashboard <span id="spanID5" class="badge">Main</span></a>
                  </li>
                  <li>
                     <a href="allUsers.html"><i class="fa fa-users "></i>Users</a>
                 </li>
                 <li>
                    <a type="reset" href="allElections.html"><i class="fa fa-edit "></i>User Elections</a>
                </li>
                <li>
                   <a href="myElections.html"><i class="fa fa-folder-open "></i>My Elections</a>
               </li>
                   <li>
                      <a href="changePassword.html"><i class="fa fa-lock "></i>Change Password</a>
                  </li>


                  <li>
                     <a onclick="logout1()" href="#"><i class="fa fa-power-off "></i>Logout</a>
                 </li>



              </ul>
            </div>

      </nav>
      <!-- /. NAV SIDE  -->
      <div id="page-wrapper" >
          <div id="page-inner">
              <div class="row">
                  <div class="col-lg-12">
                   <h2>APPROVE ELECTION</h2>
                  </div>
              </div>
               <!-- /. ROW  -->
                <hr />
              <div class="row">
                  <div class="col-lg-12 ">
                      <div class="alert alert-info">

                           <strong id="strongID">There is no notificaiton.</strong>
                      </div>

                  </div>
                  </div>

                  <div>
                    <h3 id="elecTitle">Waiting Elections For Approve or Rejected</h3>
                    <h3 id="thereIsNo" style="display:none;">There is no election.</h3>
                    <div class="main-list" id="list_div">
                      <div class="list-item">


                        <div class="butonClass">
                        </div>
                      </div>
                    </div>

                  </div>

           <!-- /. PAGE INNER  -->
          </div>
       <!-- /. PAGE WRAPPER  -->
      </div>
  <div class="footer">


          <div class="row">
              <div class="col-lg-12" >
                  &copy;  2018 | Design by: <a style="color:#fff;" target="_blank">SE301-Voted Group</a>
              </div>
          </div>
      </div>

</from>
</div>


     <!-- /. WRAPPER  -->
    <!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
    <!-- JQUERY SCRIPTS -->
    <script src="assets/js/jquery-1.10.2.js"></script>
      <!-- BOOTSTRAP SCRIPTS -->
    <script src="assets/js/bootstrap.min.js"></script>
      <!-- CUSTOM SCRIPTS -->
    <script src="assets/js/custom.js"></script>


<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDpEfxHmFK0q0lpVFWK7DmpE7vgLLgPhr0",
    authDomain: "vote-a0e5a.firebaseapp.com",
    databaseURL: "https://vote-a0e5a.firebaseio.com",
    projectId: "vote-a0e5a",
    storageBucket: "vote-a0e5a.appspot.com",
    messagingSenderId: "384488603364"
  };
  firebase.initializeApp(config);
</script>


    <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        document.getElementById("formAdminLogin").action = "admin.html";
        document.getElementById("formAdminLogin").submit();
      } else {
        // No user is signed in.
        document.getElementById("formAdminMain").action = "login.html";
        document.getElementById("formAdminMain").submit();
      }
    });
    function logout1(){
      firebase.auth().signOut().then(function() {
        console.log('Signed Out');
      }, function(error) {
        console.error('Sign Out Error', error);
      });
    }

    var count = 0;
    var electionlariCek = function(){
      const list_div = document.querySelector("#list_div");
      var userRef = firebase.database().ref().child("WaitingElections");
        userRef.on("value",function(snapshotValue){
          var exists = (snapshotValue.val() !== null);
          if(exists){
            userRef.on("child_added",function(snapshot){
              var userRef2 = firebase.database().ref().child("WaitingElections").child(snapshot.key);

              userRef2.on("child_added",function(snapshot2){
                  var userRef3 = firebase.database().ref().child("Kullanıcılar");
                  userRef3.on("child_added",function(snapshot3){
                    var userRef4 = firebase.database().ref().child("Kullanıcılar").child(snapshot3.key).child("Elections");
                    userRef4.on("child_added",function(snapshot4){
                      if(snapshot2.key == snapshot4.key){
                        count += 1;
                        document.getElementById("strongID").innerHTML = "Waiting " + count + " election for Approve or Reject "
                        if(count % 2 == 0){
                          list_div.innerHTML += "<div style='background-color:#eeeaea'><table style='width:100%' border='1px solid black'><tr>" + count + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + snapshot3.val().name + " </td><td class='dsec'><b>" + snapshot.key + "</b></td><td class='dsec'>" + snapshot2.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td class='answers' style='text-decoration:underline'>" + snapshot2.val().Option1 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot2.val().Option2 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot2.val().Option3 + "</td><td class='dsec'>" + snapshot2.val().finishDate + "</td><td><button title='Approve' onclick='approve(\"" +  snapshot.key + "\",\"" +  snapshot4.key + "\",\"" +  snapshot3.val().email + "\",\"" +  snapshot2.val().ElectionName + "\")'  class='btn'><i class='fa fa-check'></i></button><button title='Reject' onclick='reject(\"" +  snapshot4.key + "\",\"" +  snapshot3.val().email + "\",\"" +  snapshot2.val().ElectionName + "\")' class='btn2'><i class='fa fa-remove'></i></button></td></tr></table></div>"
                        }else{
                          list_div.innerHTML += "<div style='background-color:#f9f9f9'><table style='width:100%' border='1px solid black'><tr>" + count + "</tr><tr><th class='dsec'>Sender</th><th class='dsec'>Category</th><th class='dsec'>Name</th><th class='f'>Ouestion</th><th class='answers'>Option1</th><th class='answers'>Option2</th><th class='answers'>Option3</th><th class='dsec'>Due Date</th></tr><tr><td class='dsec'> " + snapshot3.val().name + " </td><td class='dsec'><b>" + snapshot.key + "</b></td><td class='dsec'>" + snapshot2.val().ElectionName + "</td><td class='f'><b style='color:blue'>" + snapshot2.val().Question + "</b></td><td class='answers' style='text-decoration:underline'>" + snapshot2.val().Option1 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot2.val().Option2 + "</td><td class='answers' style='text-decoration:underline'>" + snapshot2.val().Option3 + "</td><td class='dsec'>" + snapshot2.val().finishDate + "</td><td><button title='Approve' onclick='approve(\"" +  snapshot.key + "\",\"" +  snapshot4.key + "\",\"" +  snapshot3.val().email + "\",\"" +  snapshot2.val().ElectionName + "\")' class='btn'><i class='fa fa-check'></i></button><button title='Reject' onclick='reject(\"" +  snapshot4.key + "\",\"" +  snapshot3.val().email + "\",\"" +  snapshot2.val().ElectionName + "\")' class='btn2'><i class='fa fa-remove'></i></button></td></tr></table></div>"

                        }

                      }

                    });

                  });
                  thereIsNoElection2();
                console.log(snapshot2.val().AdminOnay);
              });
            })

          }else{
            thereIsNoElection();
          }
          showPage();
        });

    }
    electionlariCek();

    function approve(categoriKey,electionKey,email,electionName){
        if(confirm("Are you sure approve election ?")){
        firebase.database().ref("WaitingElections").on("child_added",function(approveSnap1){
            firebase.database().ref("WaitingElections").child(approveSnap1.key).child(electionKey).on("value",function(snapshot2){
              firebase.database().ref("Elections").child(approveSnap1.key).child(electionKey).update({
                ElectionName: snapshot2.val().ElectionName,
                Option1: snapshot2.val().Option1,
                Option2: snapshot2.val().Option2,
                Option3: snapshot2.val().Option3,
                Option1C: snapshot2.val().Option1C,
                Option2C: snapshot2.val().Option2C,
                Option3C: snapshot2.val().Option3C,
                AdminOnay: true,
                DateType: snapshot2.val().DateType,
                Type: snapshot2.val().Type,
                finishDate: snapshot2.val().finishDate,

                Question: snapshot2.val().Question,
                VoteCount: snapshot2.val().VoteCount,
              });
              snapshot2.ref.remove(function(error){
                  //window.onload = timedRefresh(1);
              });
            });
          });

          var from,to,subject,text;
            to= email
            subject= electionName
            text="Your election is approved by admin.\n\n\nHave a good day :) \n\nContact us : info@ivoted.com"
            $.get("http://localhost:3000/send",{to:to,subject:subject,text:text},function(data){
            if(data=="sent")
            {
              console.log("success");
            }
          });
        }
      }


    function reject(electionKey,email,electionName){
      if(confirm("Are you sure reject election ?")){
        var electionRef = firebase.database().ref("WaitingElections");
        electionRef.on("child_added",function(snapshot){
          var electionRef2 = firebase.database().ref("WaitingElections").child(snapshot.key).child(electionKey).on("value",function(snapshot2){
            firebase.database().ref("RejectedElections").child(snapshot.key).child(electionKey).update({
              DateType: snapshot2.val().DateType,
              Option1: snapshot2.val().Option1,
              Option2: snapshot2.val().Option2,
              Option3: snapshot2.val().Option3,
              Question: snapshot2.val().Question,
              finishDate: snapshot2.val().finishDate
            });// burda tarihe göre sıralandığı için db de gelen key de tarih key olduğundan karşılaştırma yapıp hangisi geldiyse onu siliyorum.
                snapshot2.ref.remove(function(error){
                    //window.onload = timedRefresh(1);
                });
          });;
        });
        var from,to,subject,text;
          to= email
          subject= electionName
          text="Your election is rejected by admin. Incorrect questions, incorrect answers, irregularities or incomplete information. Please review these conditions and try again.\n\n\nHave a good day :) \n\nContact us : info@ivoted.com"
          $.get("http://localhost:3000/send",{to:to,subject:subject,text:text},function(data){
          if(data=="sent")
          {
            console.log("success");
          }
        });
      }

    }

    function currentTime(){
    var currentdate = new Date();
    var datetime =  currentdate.getHours() + ":"
                    + currentdate.getMinutes() + ":"
                    + currentdate.getSeconds();
    console.log(datetime);
    return datetime;
    }

    function currentDay(){
    var dateObj = new Date();
    var month = ("0" + (dateObj.getMonth() + 1)).slice(-2); //months from 1-12
    var day = ("0" + dateObj.getDate()).slice(-2)
    var year = dateObj.getFullYear();
    return newdate = year + "-" + month + "-" + day;
    }

    function timedRefresh(timeoutPeriod) {
    setTimeout("location.reload(true);",timeoutPeriod); // otomatik refresh.
    }

    function showPage() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("myDiv").style.display = "block";
    }

    function showLoading() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("myDiv").style.display = "none";
    }

    function thereIsNoElection() {
      document.getElementById("elecTitle").style.display = "none";
      document.getElementById("thereIsNo").style.display = "block";
    }

    function thereIsNoElection2() {
      document.getElementById("elecTitle").style.display = "block";
      document.getElementById("thereIsNo").style.display = "none";
    }

    </script>




</body>
</html>
